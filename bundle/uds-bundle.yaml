# Copyright 2024 Defense Unicorns
# SPDX-License-Identifier: AGPL-3.0-or-later OR LicenseRef-Defense-Unicorns-Commercial

kind: UDSBundle
metadata:
  name: valkey-test
  description: A UDS bundle for deploying Valkey and on a development cluster
  # x-release-please-start-version
  version: 8.0.1-uds.0
  # x-release-please-end

packages:
  - name: valkey
    path: ../
    # x-release-please-start-version
    ref: 8.0.1-uds.0
    # x-release-please-end
    overrides:
      valkey:
        uds-valkey-config:
          values:
            - path: custom
              value:
                - direction: Ingress
                  selector:
                    app.kubernetes.io/name: valkey
                  remoteNamespace: valkey-test
                  remoteSelector:
                    app: valkey-test
                  port: 6379
                  description: "Ingress from Valkey CLI (for tests)"
            - path: copyPassword
              value:
                enabled: true
                namespace: valkey-test
                secretName: valkey-standalone
                secretKey: REDISCLI_AUTH  # This allows us to mount it in as an env var and the valkey-cli picks it right up
        valkey:
          variables:
            - name: VALKEY_RESOURCES
              path: "master.resources"
              default:
                limits:
                  cpu: 100m
                  memory: 300Mi
                requests:
                  cpu: 100m
                  memory: 300Mi
  - name: valkey
    path: ../
    # x-release-please-start-version
    ref: 8.0.1-uds.0
    # x-release-please-end
    overrides:
      valkey:
        uds-valkey-config:
          namespace: valkey-replicated-w-sentinel
          values:
            - path: custom
              value:
                - direction: Ingress
                  selector:
                    app.kubernetes.io/name: valkey
                  remoteNamespace: valkey-test
                  remoteSelector:
                    app: valkey-test
                  port: 6379
                  description: "Ingress from Valkey CLI (for tests)"
                - direction: Ingress
                  selector:
                    app.kubernetes.io/name: valkey
                  remoteNamespace: valkey-test
                  remoteSelector:
                    app: valkey-test
                  port: 26379
                  description: "Ingress from Valkey CLI (for tests) sentinel"
            - path: copyPassword
              value:
                enabled: true
                namespace: valkey-test
                secretName: valkey-replicated-w-sentinel
                secretKey: REDISCLI_AUTH
        valkey:
          namespace: valkey-replicated-w-sentinel
          values:
            - path: architecture
              value: replication
            - path: sentinel.enabled  # https://github.com/bitnami/charts/blob/main/bitnami/valkey/values.yaml#L1143
              value: true
          variables:
            - name: VALKEY_RESOURCES
              path: "master.resources"
              default:
                limits:
                  cpu: 100m
                  memory: 300Mi
                requests:
                  cpu: 100m
                  memory: 300Mi
