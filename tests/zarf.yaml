# Copyright 2024 Defense Unicorns
# SPDX-License-Identifier: AGPL-3.0-or-later OR LicenseRef-Defense-Unicorns-Commercial

# yaml-language-server: $schema=https://raw.githubusercontent.com/defenseunicorns/zarf/main/zarf.schema.json
kind: ZarfPackageConfig
metadata:
  name: valkey-test
  description: "A test that Valkey can be connected to and is functional"
  version: 0.1.0

components:
  - name: test-valkey-instances
    required: true
    manifests:
      - name: valkey-test
        namespace: valkey-test
        files:
          - valkey/uds-package.yaml
          - valkey/test-job.yaml
    images:
      - docker.io/bitnami/valkey:8.0.1-debian-12-r2
    actions:
      onDeploy:
        before:
          - description: Wait for Valkey-standalone to be healthy
            maxTotalSeconds: 300
            wait:
              cluster:
                kind: packages.uds.dev
                name: valkey
                condition: "'{.status.phase}'=Ready"
                namespace: valkey-standalone
          - description: Wait for Valkey-standalone to be ready
            maxTotalSeconds: 90
            wait:
              cluster:
                kind: pod
                name: app.kubernetes.io/name=valkey
                condition: Ready
                namespace: valkey-standalone
          - description: Wait for Valkey-replicated to be healthy
            maxTotalSeconds: 300
            wait:
              cluster:
                kind: packages.uds.dev
                name: valkey
                condition: "'{.status.phase}'=Ready"
                namespace: valkey-replicated-w-sentinel
          - description: Wait for Valkey-replicated to be ready
            maxTotalSeconds: 90
            wait:
              cluster:
                kind: pod
                name: app.kubernetes.io/name=valkey
                condition: Ready
                namespace: valkey-replicated-w-sentinel
          - description: Delete old jobs if they exist
            cmd: uds zarf tools kubectl delete -f tests/valkey/test-job.yaml || true
        after:
          - description: Watch test jobs and report their conditions
            cmd: ./tests/watch-jobs.sh
            shell:
              linux: bash
              darwin: bash
